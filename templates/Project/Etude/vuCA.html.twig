{% extends "Project/layout.html.twig" %}

{% set negoID = constant('App\\Entity\\Project\\Etude::ETUDE_STATE_NEGOCIATION') %}
{% set accepteeID = constant('App\\Entity\\Project\\Etude::ETUDE_STATE_ACCEPTEE') %}
{% set enCoursID = constant('App\\Entity\\Project\\Etude::ETUDE_STATE_COURS') %}

{% block title %}
	{{ 'dashboard.vue_ca'|trans({}, 'dashboard') }}
	{{ parent() }}
{% endblock %}

{% block content_title %}
	{{ 'dashboard.vue_ca'|trans({}, 'dashboard') }}
{% endblock %}

{% block breadcrumb_active %}
	{{ 'dashboard.vue_ca'|trans({}, 'dashboard') }}
{% endblock %}

{% block content_bundle %}
<nav class="navbar navbar-default" role="navigation">
	<div class="navbar-header">
		<a class="brand" href="{{ path('project_etude_voir', {'nom': etude.nom}) }}">
			<h4>{{ etude.reference(param('namingConvention')) }}</h4>
		</a>
	</div>
	<div class="collapse navbar-collapse navbar-ex1-collapse">
		<ul class="nav navbar-nav navbar-right">
			{# Précédent #}
			<li>
				<a href="{{ path('project_vue_ca', {'id': prevID}) }}">
					<i class="fa fa-arrow-left"></i>
					{{ 'suivi.précédent'|trans({}, 'project') }}</a>
			</li>
			{# Accès rapide #}
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">
					<i class="fa fa-th-list"></i>
					{{ 'suivi.acces_rapide'|trans({}, 'project') }}
					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu">
					<li class="nav-header">
					{% for etude in etudes %}
						{# On affiche l'état de l'étude pour le premier et à chaque changement #}
						{% if not loop.first %}
							{% if etude.stateID != etudes[loop.index0 - 1].stateID %}
								&nbsp<i class="fa fa-briefcase"></i>&nbsp
								{{ etude.getStateIDToString(etude.stateID) | trans({}, 'project') }}
								<li class="divider"></li>
							{% endif %}
						{% else %}
								&nbsp<i class="fa fa-briefcase"></i>&nbsp
								{{ etude.getStateIDToString(etude.stateID) | trans({}, 'project') }}
						{% endif %}
						<li>
							<a href="{{ path('project_vue_ca', {'id': etude.id}) }}">
								<i class="fa fa-minus"></i>
								{{ etude.reference(param('namingConvention')) }}
							</a>
						</li>
					{% endfor %}
				</ul>
			</li>
			{# Suivant #}
			<li>
				<a href="{{ path('project_vue_ca', {'id': nextID}) }}">{{ 'suivi.suivant'|trans({}, 'project') }}
					<i class="fa fa-arrow-right"></i>
				</a>
			</li>
		</ul>
	</div>
</nav>

<table class="table table-bordered table-striped" style="padding-top: 0px;">
	<tr class="alert {{ getColor(etude) }}">
		<th>
			<h5>{{ etude.getStateIDToString(etude.stateID) | trans({}, 'project') }}</h5>
		</th>
		<td colspan="5">
			<strong>{{ etude.stateDescription }}</strong>
		</td>
	</tr>
	<tr>
		<td colspan="6">{{ etude.description }}</td>
	</tr>
	<tr>
		<th>{{ 'suivi.client'|trans({}, 'project') }}</th>
		<td colspan="2">{% include "Project/Etude/Buttons/Prospect.html.twig" with  {'prospect':  etude.prospect} %}</td>

		<th>{{ 'suivi.suiveur'|trans({}, 'project') }}</th>
		<td colspan="2">{% include "Project/Etude/Buttons/Suiveur.html.twig" with  {'suiveur':  etude.suiveur} %}</td>
	</tr>
	<tr>
		<td colspan="6" style="text-align: center;">
			{% include "Project/Etude/Tools/Intervenants.html.twig" %}
		</td>
	</tr>
	<tr>
		<th>
			<div>{{ 'suivi.date_lancement'|trans({}, 'project') }}</div>
			<div>{{ 'suivi.date_fin'|trans({}, 'project') }}</div>
		</th>
		<td>
			{% include "Project/Etude/Tools/DatesEtude.html.twig" %}
		</td>
		<td colspan="3" style="text-align: center;">
			{{ 'suivi.avancement'|trans({}, 'project') }}
			<br>
			{% include "Project/Etude/Tools/AffichageAvancement.html.twig" %}
		</td>
		<td style="text-align: center;">
			{{ 'suivi.dernier_contact'|trans({}, 'project') }}
			<br>
			{% include "Project/Etude/Tools/DateDernierContact.html.twig" %}
		</td>
	</tr>
	<tr>
		{# CE / BDC #}
		<td style="text-align: center;">
			{% if etude.ccaActive %}
				<span class="label label-{{ getColorDoc(etude.bdc) }}">{{ 'suivi.bdc'|trans({}, 'project') }}</span>
			{% else %}
			<span class="label label-{{ getColorDoc(etude.ce) }}">{{ 'suivi.ce'|trans({}, 'project') }}</span>
			{% endif %}
		</td>
		{# FA #}
		<td style="text-align: center;">
			<span class="label label-{{ getColorDoc(etude.fa) }}">{{ 'suivi.fa'|trans({}, 'project') }}</span>
		</td>
		{# RMs #}
		<td style="text-align: center;">
			{# We take the first one (arbitrary) to display a label color... #}
			<span class="label label-{{ getColorDoc(etude.missions[0]??NULL) }}">{{ 'suivi.rm'|trans({}, 'project') }}</span>&nbsp
			{% include "Project/Etude/Tools/EtatDocuments.html.twig" with {'docs': etude.missions, 'title': 'intervenantPrenomNom'} %}
		</td>
		{# PVRIs #}
		<td style="text-align: center;">
			<span class="label label-{{ getColorDoc(etude.pvis[0]??NULL) }}">{{ 'suivi.pvi'|trans({}, 'project') }}</span>&nbsp
			{% include "Project/Etude/Tools/EtatDocuments.html.twig" with {'docs': etude.pvis, 'title': 'date'} %}
		</td>
		{# PVRF #}
		<td style="text-align: center;">
			<span class="label label-{{ getColorDoc(etude.pvr) }}">{{ 'suivi.pvr'|trans({}, 'project') }}</span>
		</td>
		{# FS #}
		<td style="text-align: center;">
			<span class="label label-{{ getColorDoc(etude.fs) }}">{{ 'suivi.fs'|trans({}, 'project') }}</span>
		</td>
	</tr>
	<tr>
		<th colspan="2">
			{{ 'suivi.jeh'|trans({}, 'project') }}
			<br>
			{{ 'suivi.prix_ht'|trans({}, 'project') }}
		</th>
		<td colspan="4">
			{% include "Project/Etude/Tools/PrixEtJEH.html.twig" %}
		</td>
	</tr>
</table>

<div id="ganttChart" style="width: 100%;"></div>
{% endblock %}

{% block javascript %}
	{{ parent() }}
	<script src="{{ asset('js/highcharts.js') }}"></script>
	<script src="{{ asset('js/highcharts-fr.js') }}"></script>
	<script src="{{ asset('js/exporting.js') }}"></script>

	<script type="text/javascript">
		{{ chart(chart) }}
		{% include 'Project/Etude/Tools/Avancement.js.twig' %}
	</script>
{% endblock %}
